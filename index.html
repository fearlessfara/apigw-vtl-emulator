<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>VTL Emulator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        #editorTemplate, #editorBody, #editorVariables, #editorContext {
            height: 200px;
            border: 1px solid #ccc;
        }
        #result {
            white-space: pre-wrap;
            font-family: monospace;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: .25rem;
            min-height: 100px;
        }
        .editor-tab-content {
            display: none;
        }
        .editor-tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <h3 class="mb-3">VTL Emulator</h3>

    <ul class="nav nav-tabs mb-2" id="vtlTabs">
        <li class="nav-item"><a class="nav-link active" href="#" data-target="#template">Template</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-target="#body">Body</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-target="#variables">Variables</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-target="#context">Context</a></li>
    </ul>

    <div id="template" class="editor-tab-content active"><div id="editorTemplate"></div></div>
    <div id="body" class="editor-tab-content"><div id="editorBody"></div></div>
    <div id="variables" class="editor-tab-content"><div id="editorVariables"></div></div>
    <div id="context" class="editor-tab-content"><div id="editorContext"></div></div>

    <div class="mt-3 d-flex justify-content-between align-items-center">
        <button id="renderBtn" class="btn btn-primary">Render</button>
        <span class="text-muted">Result:</span>
    </div>

    <div id="result" class="mt-2"></div>
</div>

<!-- Monaco Editor CDN -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
<script>
  let editors = {};

  require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs' } });
  require(['vs/editor/editor.main'], function () {
    editors.template = monaco.editor.create(document.getElementById('editorTemplate'), {
      value: '$input.body',
      language: 'javascript',
      minimap: { enabled: false }
    });
    editors.body = monaco.editor.create(document.getElementById('editorBody'), {
      value: '{\n  "foo": "bar"\n}',
      language: 'json',
      minimap: { enabled: false }
    });
    editors.variables = monaco.editor.create(document.getElementById('editorVariables'), {
      value: '{}',
      language: 'json',
      minimap: { enabled: false }
    });
    editors.context = monaco.editor.create(document.getElementById('editorContext'), {
      value: '{}',
      language: 'json',
      minimap: { enabled: false }
    });
  });

  document.getElementById('vtlTabs').addEventListener('click', (e) => {
    if (e.target.dataset.target) {
      e.preventDefault();

      document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
      e.target.classList.add('active');

      document.querySelectorAll('.editor-tab-content').forEach(el => el.classList.remove('active'));
      const target = document.querySelector(e.target.dataset.target);
      target.classList.add('active');

      // Ensure Monaco editor relayouts when shown
      const editorKey = e.target.dataset.target.replace('#', '');
      if (editors[editorKey]) {
        setTimeout(() => editors[editorKey].layout(), 0);
      }
    }
  });

  document.getElementById('renderBtn').addEventListener('click', async () => {
    const template = editors.template.getValue();
    const body = editors.body.getValue();
    const variables = editors.variables.getValue();
    const context = editors.context.getValue();

    const parsedBody = (() => {
      try { return JSON.parse(body); } catch (e) { return {}; }
    })();
    const parsedVars = (() => {
      try { return JSON.parse(variables); } catch (e) { return {}; }
    })();
    const parsedContext = (() => {
      try { return JSON.parse(context); } catch (e) { return {}; }
    })();

    const res = await fetch('https://l7g5xwizt5.execute-api.eu-west-1.amazonaws.com/vtl', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        template,
        context: {
          body: JSON.stringify(parsedBody),
          parsedBody,
          query: parsedVars,
          pathParams: {},
          headers: {},
          event: { httpMethod: 'POST', path: '/vtl' },
          eventContext: parsedContext
        }
      })
    });

    const data = await res.json();
    document.getElementById('result').textContent = data.result || data.error || 'Unknown error';
  });
</script>
</body>
</html>
