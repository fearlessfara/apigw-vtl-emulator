<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>VTL Emulator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        #editorTemplate, #editorBody, #editorContext {
            height: 200px;
            border: 1px solid #ccc;
        }

        #result {
            white-space: pre-wrap;
            font-family: monospace;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: .25rem;
            min-height: 100px;
        }

        .editor-tab-content {
            display: none;
        }

        .editor-tab-content.active {
            display: block;
        }

        .kv-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .kv-row select, .kv-row input {
            flex: 1;
        }

        #loadingCat {
            display: none;
            text-align: center;
            margin: 1rem 0;
        }

        #loadingCat img {
            height: 80px;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <h3 class="mb-3">VTL Emulator</h3>

    <ul class="nav nav-tabs mb-2" id="vtlTabs">
        <li class="nav-item"><a class="nav-link active" href="#" data-target="#template">Template</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-target="#body">Body</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-target="#variables">Variables</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-target="#context">Context</a></li>
    </ul>

    <div id="template" class="editor-tab-content active">
        <div id="editorTemplate"></div>
    </div>
    <div id="body" class="editor-tab-content">
        <div id="editorBody"></div>
    </div>
    <div id="variables" class="editor-tab-content">
        <div id="variableContainer"></div>
        <button id="addVariable" class="btn btn-sm btn-secondary mt-2">+ Add Variable</button>
    </div>
    <div id="context" class="editor-tab-content">
        <div id="editorContext"></div>
    </div>

    <div id="loadingCat"><img src="https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif" alt="Loading cat"/></div>

    <div class="mt-3 d-flex justify-content-between align-items-center">
        <button id="renderBtn" class="btn btn-primary">Render</button>
        <span class="text-muted">Result:</span>
    </div>

    <div id="result" class="mt-2"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
<script>
  let editors = {};

  require.config({paths: {vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs'}});
  require(['vs/editor/editor.main'], function () {
    editors.template = monaco.editor.create(document.getElementById('editorTemplate'), {
      value: '$input.body',
      language: 'javascript',
      minimap: {enabled: false}
    });
    editors.body = monaco.editor.create(document.getElementById('editorBody'), {
      value: '{\n  "foo": "bar"\n}',
      language: 'json',
      minimap: {enabled: false}
    });
    editors.context = monaco.editor.create(document.getElementById('editorContext'), {
      value: '{}',
      language: 'json',
      minimap: {enabled: false}
    });
  });

  document.getElementById('vtlTabs').addEventListener('click', (e) => {
    if (e.target.dataset.target) {
      e.preventDefault();
      document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
      e.target.classList.add('active');
      document.querySelectorAll('.editor-tab-content').forEach(el => el.classList.remove('active'));
      const target = document.querySelector(e.target.dataset.target);
      target.classList.add('active');
      const editorKey = e.target.dataset.target.replace('#', '');
      if (editors[editorKey]) {
        setTimeout(() => editors[editorKey].layout(), 0);
      }
    }
  });

  document.getElementById('addVariable').addEventListener('click', () => {
    const container = document.getElementById('variableContainer');
    const row = document.createElement('div');
    row.className = 'kv-row';
    row.innerHTML = `
      <select class="form-select var-type">
        <option value="query">Query</option>
        <option value="path">Path</option>
        <option value="header">Header</option>
        <option value="stage">Stage</option>
      </select>
      <input class="form-control var-key" placeholder="Key" />
      <input class="form-control var-value" placeholder="Value" />
      <button class="btn btn-danger btn-sm remove-btn">x</button>
    `;
    row.querySelector('.remove-btn').addEventListener('click', () => row.remove());
    container.appendChild(row);
  });

  document.getElementById('renderBtn').addEventListener('click', async () => {
    const template = editors.template.getValue();
    const body = editors.body.getValue();
    const context = editors.context.getValue();

    const parsedBody = (() => {
      try {
        return JSON.parse(body);
      } catch {
        return {};
      }
    })();
    const parsedContext = (() => {
      try {
        return JSON.parse(context);
      } catch {
        return {};
      }
    })();

    const vars = {};
    document.querySelectorAll('#variableContainer .kv-row').forEach(row => {
      const type = row.querySelector('.var-type').value;
      const key = row.querySelector('.var-key').value;
      const value = row.querySelector('.var-value').value;
      if (!vars[type]) vars[type] = {};
      vars[type][key] = value;
    });

    document.getElementById('loadingCat').style.display = 'block';
    document.getElementById('result').textContent = '';

    const res = await fetch('https://l7g5xwizt5.execute-api.eu-west-1.amazonaws.com/vtl', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        template,
        context: {
          body: JSON.stringify(parsedBody),
          parsedBody,
          query: vars.query || {},
          pathParams: vars.path || {},
          headers: vars.header || {},
          stageVariables: vars.stage || {},
          event: {httpMethod: 'POST', path: '/vtl'},
          eventContext: parsedContext
        }
      })
    });

    const data = await res.json();
    document.getElementById('loadingCat').style.display = 'none';
    document.getElementById('result').textContent = data.result || data.error || 'Unknown error';
  });
</script>
</body>
</html>
