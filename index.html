<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <title>VTL Emulator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        #editorTemplate, #editorBody, #editorContext {
            height: 200px;
            border: 1px solid #ccc;
        }

        #result {
            white-space: pre-wrap;
            font-family: monospace;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: .25rem;
            min-height: 100px;
        }

        .editor-tab-content {
            display: none;
        }

        .editor-tab-content.active {
            display: block;
        }

        .kv-row {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .kv-row select, .kv-row input {
            flex: 1;
        }

        #loadingCat {
            display: none;
            text-align: center;
            margin: 1rem 0;
        }

        #loadingCat img {
            height: 80px;
        }
    </style>
</head>
<body>
<div class="container py-4">
    <h3 class="mb-3">VTL Emulator</h3>

    <ul class="nav nav-tabs mb-2" id="vtlTabs">
        <li class="nav-item"><a class="nav-link active" href="#" data-target="#template">Template</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-target="#body">Body</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-target="#variables">Variables</a></li>
        <li class="nav-item"><a class="nav-link" href="#" data-target="#context">Context</a></li>
    </ul>

    <div id="template" class="editor-tab-content active">
        <div id="editorTemplate"></div>
    </div>
    <div id="body" class="editor-tab-content">
        <div id="editorBody"></div>
    </div>
    <div id="variables" class="editor-tab-content">
        <div id="variableContainer"></div>
        <button id="addVariable" class="btn btn-sm btn-secondary mt-2">+ Add Variable</button>
    </div>
    <div id="context" class="editor-tab-content">
        <div id="editorContext"></div>
    </div>

    <div id="loadingCat"><img src="https://media.giphy.com/media/JIX9t2j0ZTN9S/giphy.gif" alt="Loading cat"/></div>

    <div class="mt-3 d-flex justify-content-between align-items-center">
        <button id="renderBtn" class="btn btn-primary">Render</button>
        <span class="text-muted">Result:</span>
    </div>

    <div id="result" class="mt-2"></div>
    <footer class="mt-5 text-center text-muted small">
        <hr>
        <p>&copy; 2025 VTL Emulator - Christian Gennaro Faraone. All rights reserved. |
            Found a bug or issue? <a href="mailto:christiangenn99+vtl@gmail.com">Contact me here</a></p>
    </footer>
</div>

<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.52.2/min/vs/loader.js"></script>
<script>
  let editors = {};

  require.config({paths: {vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.52.2/min/vs'}});
  require(['vs/editor/editor.main'], function () {
    monaco.languages.register({id: 'velocity'});
    monaco.languages.setMonarchTokensProvider('velocity', {
      tokenizer: {
        root: [
          [/\$[a-zA-Z_][\w\.]*/, 'variable'],
          [/#.*/, 'comment'],
          [/"([^"\\]|\\.)*$/, 'string.invalid'],
          [/"([^"\\]|\\.)*"/, 'string'],
          [/[{}]/, 'delimiter.bracket'],
          [/[\[\]]/, 'delimiter.array'],
        ]
      }
    });
    monaco.languages.registerCompletionItemProvider('velocity', {
      triggerCharacters: ['$', '.'],
      provideCompletionItems: () => {
        return {
          suggestions: [
            {
              label: '$input',
              kind: monaco.languages.CompletionItemKind.Variable,
              insertText: '$input',
              documentation: 'AWS input utility'
            },
            {
              label: '$input.json',
              kind: monaco.languages.CompletionItemKind.Function,
              insertText: '$input.json("$1")',
              insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              documentation: 'JSON parser'
            },
            {
              label: '$util.escapeJavaScript',
              kind: monaco.languages.CompletionItemKind.Function,
              insertText: '$util.escapeJavaScript($1)',
              insertTextRules: monaco.languages.CompletionItemInsertTextRule.InsertAsSnippet,
              documentation: 'JS escape'
            },
            {
              label: '$context.requestId',
              kind: monaco.languages.CompletionItemKind.Property,
              insertText: '$context.requestId',
              documentation: 'Request ID'
            }
          ]
        };
      }
    });

    editors.template = monaco.editor.create(document.getElementById('editorTemplate'), {
      value: '$input.json("$")\n$util.escapeJavaScript($input.body)',
      language: 'velocity',
      minimap: {enabled: false}
    });
    editors.body = monaco.editor.create(document.getElementById('editorBody'), {
      value: '{\n  \"foo\": \"bar\"\n}',
      language: 'json',
      minimap: {enabled: false}
    });
    editors.context = monaco.editor.create(document.getElementById('editorContext'), {
      value: `{
  "accountId": "112233445566",
  "apiId": "a1b2c3d4e5",
  "domainPrefix": "a1b2c3d4e5",
  "domainName": "a1b2c3d4e5.execute-api.up-down-1.amazonaws.com",
  "extendedRequestId": "ABCdEFGhIJKLMnO=",
  "httpMethod": "POST",
  "stage": "prod",
  "path": "/prod",
  "protocol": "HTTP/1.1",
  "requestId": "7b776519-78de-4539-8e04-ff300f5c2528",
  "requestTime": "4/Mar/2021:05:43:21 +0000",
  "requestTimeEpoch": "1614836601444",
  "resourceId": "1a2b3c4d5e",
  "resourcePath": "/",
  "authorizer": {
    "claims": {
      "sub": "4bf08bda-88a3-47b8-90b0-f08291a9e7af",
      "aud": "tfcrxvwog56v9sxpcbcesams65",
      "email_verified": true,
      "event_id": "17c18670-01b0-4bba-b118-1bfecf2db099",
      "token_use": "id",
      "auth_time": 1640159000,
      "iss": "https://cognito-idp.ap-south-1.amazonaws.com/ap-south-1_cpdRLf1K2h",
      "cognito:username": "yqpsze151",
      "exp": 4793760722,
      "iat": 1640160722,
      "email": "yqpsze151@t9tZ1f139.net"
    },
    "principalId": "4bf08bda-88a3-47b8-90b0-f08291a9e7af"
  },
  "identity": {
    "accountId": "778899101112",
    "apiKey": "DM8ua1AIkO292b9gAwRst87qNc296DyNEU3y8Ll4",
    "apiKeyId": "2zmu863a9k",
    "caller": "4bf08bda-88a3-47b8-90b0-f08291a9e7af",
    "cognitoAuthenticationProvider": "\\"cognito-idp.ap-south-1.amazonaws.com/ap-south-1_cpdRLf1K2h\\",\\"cognito-idp.ap-south-1.amazonaws.com/ap-south-1_cpdRLf1K2h:CognitoSignIn:f350ee4c-4b07-40f7-b7f7-9f2d1c4cc21e\\"",
    "cognitoAuthenticationType": "authenticated",
    "cognitoIdentityId": "ap-south-1:4bf08bda-88a3-47b8-90b0-f08291a9e7af",
    "cognitoIdentityPoolId": "ap-south-1:5f658b59-d1fb-4499-8b24-92246a5c2a05",
    "principalOrgId": "o-wsr8h7a6s4",
    "sourceIp": "158.233.247.210",
    "user": "api-caller",
    "userAgent": "Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/51.0.2704.103 Safari/537.36",
    "userArn": "arn:aws:iam::778899101112:role/api-caller",
    "clientCert": {
      "clientCertPem": "-----BEGIN CERTIFICATE-----\\nMIIEZTCCAk0CAQEwDQ...",
      "subjectDN": "C=US,ST=Washington,L=Seattle,O=Amazon Web Services,OU=Security,CN=My Client",
      "issuerDN": "C=US,ST=Washington,L=Seattle,O=Amazon Web Services,OU=Security,CN=My Private CA",
      "serialNumber": "1",
      "validity": {
        "notAfter": "Aug  5 00:28:21 2120 GMT",
        "notBefore": "Aug 29 00:28:21 2020 GMT"
      }
    }
  }
}`,
      language: 'json',
      minimap: {enabled: false}
    });
  });

  document.getElementById('vtlTabs').addEventListener('click', (e) => {
    if (e.target.dataset.target) {
      e.preventDefault();
      document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));
      e.target.classList.add('active');
      document.querySelectorAll('.editor-tab-content').forEach(el => el.classList.remove('active'));
      const target = document.querySelector(e.target.dataset.target);
      target.classList.add('active');
      const editorKey = e.target.dataset.target.replace('#', '');
      if (editors[editorKey]) {
        setTimeout(() => editors[editorKey].layout(), 0);
      }
    }
  });

  document.getElementById('addVariable').addEventListener('click', () => {
    const container = document.getElementById('variableContainer');
    const row = document.createElement('div');
    row.className = 'kv-row';
    row.innerHTML = `
      <select class="form-select var-type">
        <option value="query">Query</option>
        <option value="path">Path</option>
        <option value="header">Header</option>
        <option value="stage">Stage</option>
      </select>
      <input class="form-control var-key" placeholder="Key" />
      <input class="form-control var-value" placeholder="Value" />
      <button class="btn btn-danger btn-sm remove-btn">x</button>
    `;
    row.querySelector('.remove-btn').addEventListener('click', () => row.remove());
    container.appendChild(row);
  });

  document.getElementById('renderBtn').addEventListener('click', async () => {
    const template = editors.template.getValue();
    const body = editors.body.getValue();
    const context = editors.context.getValue();

    const parsedBody = (() => {
      try {
        return JSON.parse(body);
      } catch {
        return {};
      }
    })();
    const parsedContext = (() => {
      try {
        return JSON.parse(context);
      } catch {
        return {};
      }
    })();

    const vars = {};
    document.querySelectorAll('#variableContainer .kv-row').forEach(row => {
      const type = row.querySelector('.var-type').value;
      const key = row.querySelector('.var-key').value;
      const value = row.querySelector('.var-value').value;
      if (!vars[type]) vars[type] = {};
      vars[type][key] = value;
    });

    document.getElementById('loadingCat').style.display = 'block';
    document.getElementById('result').textContent = '';

    const res = await fetch('https://l7g5xwizt5.execute-api.eu-west-1.amazonaws.com/vtl', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        template,
        context: {
          body: JSON.stringify(parsedBody),
          parsedBody,
          query: vars.query || {},
          pathParams: vars.path || {},
          headers: vars.header || {},
          stageVariables: vars.stage || {},
          event: {httpMethod: 'POST', path: '/vtl'},
          eventContext: parsedContext
        }
      })
    });

    const data = await res.json();
    document.getElementById('loadingCat').style.display = 'none';
    document.getElementById('result').textContent = data.result || data.error || 'Unknown error';
  });
</script>
</body>
</html>
